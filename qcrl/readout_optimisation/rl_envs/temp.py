from jax import config, jit
import numpy as np
import jax.numpy as jnp
from resonator_environment import ResonatorEnv

config.update("jax_enable_x64", True)

float_dtype = jnp.float64
complex_dtype = jnp.complex128

env = ResonatorEnv()
dict_info = env.get_params()

items_list = list(dict_info.items())
array = np.array(items_list)

T0, T1, NUM_ACTION, NUM_SIM, TS_ACTION, TS_SIM, batch_size = array[:, 1]

rectangular_drive = jnp.zeros((1, NUM_ACTION), dtype=complex_dtype) + 3.55

rec = rectangular_drive

res_imag = -2.06014618

longitudinal_drive = (
    -0.5
    * (
        res_imag * env.chi_eff * (1 - jnp.exp(env.neg_kappa_half * TS_ACTION))
        + res_imag * env.chi_eff
    ).reshape(1, NUM_ACTION)
    * 0.1
)

longitudinal_drive = jnp.zeros((1, NUM_ACTION), dtype=complex_dtype) + 0.1 * 3.65

long_drive = longitudinal_drive

for i in range(batch_size - 1):
    long_drive = jnp.concatenate(
        (long_drive, longitudinal_drive), axis=0, dtype=complex_dtype
    )

resonator_state = jnp.zeros((batch_size, 1), dtype=complex_dtype) + 0.0

# action = jnp.concatenate((rec, resonator_state), axis=-1)

custom_drive = jnp.array(
    [
        5.82269169e-01 - 1.83306420e01j,
        -6.32144734e-01 - 1.56352532e01j,
        -2.64604250e-02 - 1.46548808e01j,
        6.09634109e-01 - 1.04443276e01j,
        -1.86440527e00 - 9.17245328e00j,
        3.71064432e-01 - 3.95238668e00j,
        -1.24474630e00 - 3.20790976e00j,
        7.57565722e-01 - 5.36159933e00j,
        -1.15463413e00 - 2.05934376e00j,
        7.75360167e-01 - 3.28723282e00j,
        1.11105673e00 - 2.52747327e00j,
        1.14965038e-01 - 3.26454759e00j,
        4.78339307e-01 - 2.46498689e00j,
        -1.39503509e00 - 4.28021252e00j,
        1.16843767e00 - 2.27688730e00j,
        -3.83161753e-01 - 3.64589363e00j,
        -4.18514423e-01 - 3.07196587e00j,
        1.45408019e00 - 2.56942809e00j,
        -1.33152902e00 - 3.91978949e00j,
        -5.29357344e-01 - 2.88421929e00j,
        4.80289571e-01 - 3.18066150e00j,
        3.26107480e-01 - 4.09761667e00j,
        2.90860189e-03 - 2.93299377e00j,
        1.56211769e-01 - 3.47489685e00j,
        2.80092806e-01 - 3.18289429e00j,
        -7.68066272e-01 - 3.38231415e00j,
        6.18330203e-01 - 4.40397322e00j,
        -2.51048729e-01 - 2.40300238e00j,
        6.25366271e-01 - 4.24432516e00j,
        -9.37713403e-02 - 3.58553559e00j,
        5.36404783e-02 - 3.69977444e00j,
        5.27061243e-02 - 3.80398899e00j,
        -8.66564177e-02 - 3.43418628e00j,
        4.82635163e-01 - 3.88222247e00j,
        7.49657024e-02 - 3.53009820e00j,
        3.66678624e-02 - 3.93203318e00j,
        -1.68389641e-01 - 3.76680523e00j,
        1.57356653e-01 - 3.76854509e00j,
        6.00290345e-02 - 3.78565013e00j,
        1.76105406e-01 - 3.85670096e00j,
        2.74434919e-02 - 3.73952985e00j,
        3.83946532e-02 - 3.77685577e00j,
        -2.68801302e-02 - 3.59418958e00j,
        -5.13057262e-01 - 7.19085336e-03j,
        -1.45564377e-01 + 3.36148083e00j,
        7.22963214e-01 + 4.03718710e00j,
        -4.32236433e00 + 1.40356004e00j,
        3.26685905e00 - 4.98566419e00j,
        -1.80928946e00 - 8.51010978e-01j,
        5.14076352e-01 - 6.89921975e00j,
        4.22927886e-01 + 5.39473891e-01j,
        4.29435670e00 + 8.19875747e-01j,
        5.89221120e00 - 4.39284623e00j,
        1.88921019e00 - 3.56101125e00j,
        -1.09454654e00 - 5.19745588e00j,
        3.08209956e00 - 1.15915799e01j,
        3.53212237e00 - 7.21424371e-01j,
        -1.29335478e00 - 7.14224815e00j,
        -1.71072915e00 - 1.17030227e01j,
        -7.42167234e-01 - 7.07588673e00j,
        6.81352854e00 - 1.29056358e01j,
    ],
    dtype=complex_dtype,
).reshape(1, NUM_ACTION)

custom_drive2 = 1j * jnp.conjugate(custom_drive)

custom_state = jnp.array([0.0], dtype=complex_dtype).reshape(1, 1)
custom_state2 = 1j * jnp.conjugate(custom_state)
custom_batched_state = (
    jnp.zeros((batch_size, 1), dtype=complex_dtype) + 2.19377711 - 0.2633629j
) * 0.2

action = jnp.concatenate(
    (
        long_drive.real,
        long_drive.imag,
        # custom_batched_state.real,
        # custom_batched_state.imag,
    ),
    axis=-1,
    dtype=complex_dtype,
)

a, b, c, d, info = env.step(action)

print(f"info: {info}")

env.render(custom_drive, custom_state, index=0)

"""
Vacuum Readout
Maximum Reward: 3.7704138044185282
Separation at Max Reward: [3.7704138]
Photon at Max: [7.97910092]
Bandwidth at Max: [[-3.33066907e-16]]
3.2us

Max Reward Obtained: 3.8339075569054306
Separation at Max Reward: [3.82332138]
Photon at Max Reward: [7.97148308]
Bandwidth at Max Reward: [[0.24691358]]
2.7us

-2.06014618j

A+R Readout
Max Reward Obtained: -96.25767052301387
Separation at Max Reward: [3.74232948]
Photon at Max: [8.00791206]
Bandwidth at Max: [[-3.33066907e-16]]
2.3us

A+L Readout wo Kerr and Gamma
Maximum Reward: 3.999817965012203
Separation at Max Reward: [3.99981797]
Photon at Max: [7.9996362]
Bandwidth at Max: [[0.]]
10us

A+L Readout w Kerr and Gamma
Maximum Reward: -96.09581105457289
Separation at Max Reward: [3.90418895]
Photon at Max: [11.0951808]
Bandwidth at Max: [[0.]]
Time taken 5.85us


Complex Action with Cloaking
[
        -1.76363215 + 7.47867465e00j,
        1.45123065 + 8.37511122e00j,
        2.16286659 + 6.81536973e00j,
        -1.89950794 + 9.86424163e-01j,
        -1.0951671 + 3.92279029e00j,
        1.29541174 + 2.89965451e00j,
        -0.59959225 + 2.82212377e00j,
        0.68357438 + 3.15843821e00j,
        -0.56981046 + 2.63452381e00j,
        1.80789351 + 3.20346475e00j,
        -1.11340985 + 2.66560107e00j,
        1.04290172 + 3.35500836e00j,
        -1.47978723 + 1.96030825e00j,
        1.12643905 + 3.21657717e00j,
        1.10523611 + 4.17771637e00j,
        -1.57069266 + 2.74708807e00j,
        0.78505881 + 2.87393808e00j,
        0.77856809 + 4.34716314e00j,
        -0.05674863 + 3.04446906e00j,
        0.35236437 + 3.30209911e00j,
        0.12937228 + 3.43653649e00j,
        -0.51999651 + 3.20424765e00j,
        0.83546005 + 3.86598527e00j,
        0.04282562 + 3.63748670e00j,
        0.25979817 + 3.16538900e00j,
        -0.22579031 + 3.72094691e00j,
        -0.15714848 + 3.32035333e00j,
        0.83990976 + 3.95251453e00j,
        -0.53462353 + 3.69702190e00j,
        0.45067154 + 3.94601554e00j,
        0.06876303 + 3.71294916e00j,
        0.34239724 + 3.54432136e00j,
        -0.28335668 + 3.87410223e00j,
        0.19973299 + 3.79095227e00j,
        0.35572954 + 3.68423730e00j,
        -0.21296047 + 4.05661076e00j,
        0.14307167 + 3.67210925e00j,
        0.01245901 + 4.02947456e00j,
        0.14908602 + 3.63136560e00j,
        -0.09474931 + 3.89942080e00j,
        0.05978119 + 3.87188375e00j,
        0.29105585 + 2.40469739e00j,
        -5.29986978 - 1.02324009e01j,
        1.03545338 - 6.22235239e-03j,
        9.95928288 - 1.03231955e01j,
        -2.08755597 - 5.96297503e00j,
        2.77124286 + 2.20843226e00j,
        2.02335715 - 2.97137439e00j,
        -2.10546806 - 5.14074028e00j,
        0.48477955 - 4.46932167e00j,
        -5.90931833 + 1.58012211e-01j,
        0.60663775 - 1.13317162e00j,
        0.8045283 - 7.67468333e00j,
        7.53545582 - 8.31820130e00j,
        3.55490983 - 8.39307785e00j,
        2.93335527 - 7.33340979e-01j,
        6.48033559 + 5.76431990e00j,
        1.95541501 - 2.40821600e00j,
        -4.08921331 + 2.97604501e00j,
        10.47285795 + 6.33377373e00j,
        7.94311106 - 2.83325016e00j,
    ]
Resonator State
2.19377711 - 0.2633629j

Complex Action from Vacuum State
[[ 9.23887789e-01-17.67309189j, -6.11569248e-01-15.34710526j,
            -6.55461550e-01-14.25874352j,  5.16308770e-01-10.69391131j,
            -1.14884749e+00 -9.3143481j ,  3.20036337e-01 -4.07819569j,
            -3.71762142e-01 -2.98087895j,  4.81075831e-01 -5.95039666j,
            -5.95066026e-01 -2.26902112j,  1.44237932e-02 -3.4279874j ,
             1.20283589e+00 -2.34226972j,  1.76743791e-01 -3.33431989j,
             8.64280686e-01 -2.44367465j, -1.75134033e+00 -4.04343128j,
             8.65245983e-01 -2.73466855j, -3.15302312e-01 -3.42085272j,
            -2.78255809e-01 -3.08072388j,  1.23461924e+00 -2.34864414j,
            -1.14519343e+00 -4.11281228j,  4.04482484e-01 -2.92809635j,
            -1.91981718e-01 -3.16781193j,  1.05064902e-01 -3.49675447j,
            -3.66245816e-02 -3.30207855j,  4.54077125e-01 -3.66091758j,
             5.38888276e-01 -3.51573408j, -1.11894108e+00 -3.03892761j,
             8.95507336e-01 -4.32349712j, -8.02986696e-01 -2.49169081j,
             8.28749537e-01 -4.35515076j, -1.16845341e-01 -3.69587421j,
             2.14898121e-01 -3.49431813j,  1.44748949e-03 -3.79315794j,
             6.39524544e-02 -3.38035136j,  2.40672156e-01 -4.09904301j,
            -9.15892422e-02 -3.36886764j,  3.99384368e-02 -3.70069891j,
             3.53776887e-01 -3.99501175j, -3.43897427e-02 -3.81688207j,
             2.41420921e-01 -3.69893551j, -7.14379083e-02 -3.91576469j,
             9.92108211e-01 -3.76347542j,  3.07614803e+00 +2.9616493j ,
            -1.13859333e+00 -4.60762799j,  1.63971245e+00 -0.25602996j,
            -5.12719274e+00 +1.20010048j,  2.76049256e+00 +0.49060702j,
            -5.01609862e+00 -6.80188179j, -2.68098451e-01 +2.38041937j,
            -2.73420215e+00 +3.24155211j, -2.07185060e+00 -3.05936277j,
             2.19657272e-01 -5.8086884j , -1.38231099e+00 -4.55361903j,
             1.84832737e+00 -1.32634431j,  1.83428019e+00 -3.46827745j,
            -3.52745622e+00 -4.03212309j, -2.46151417e+00-11.65082216j,
            -1.71386376e+00 -8.65112782j, -2.70322829e+00 -4.01593029j,
             2.26791546e+00 -6.13610864j, -4.46476825e-01 -1.12799898j,
             3.67821932e+00 -8.97837579j]]



"""
